# Data Model: Konflux Onboarding for Podman Desktop

**Date**: 2025-11-19
**Feature**: 001-konflux-podman-desktop

## Overview

This document defines the key entities and their relationships for the Konflux build pipeline implementation. Since this is a CI/CD infrastructure project rather than a traditional application, the "data model" represents configuration artifacts and build pipeline state.

## Entities

### 1. Upstream Source Reference

**Description**: Configuration pointing to upstream podman-desktop repository

**Attributes**:
- `repository_url`: string (github.com/podman-desktop/podman-desktop)
- `reference_type`: enum (tag, commit, branch) - defaulting to `tag`
- `reference_value`: string (e.g., `v1.10.0`)
- `submodule_path`: string (e.g., `upstream/podman-desktop`)
- `last_updated`: timestamp

**Validation Rules**:
- `repository_url` must be valid HTTPS git URL
- `reference_value` must exist in upstream repository
- For `reference_type=tag`, must match pattern `v*.*.*` (semantic versioning)

**State Transitions**:
```
INITIAL → CONFIGURED (submodule added)
CONFIGURED → UPDATED (reference changed to new tag)
```

**Relationships**:
- Referenced by Build Pipeline Configuration
- Updated triggers new Build Execution

### 2. Patch File

**Description**: Modification to be applied to upstream source before build

**Attributes**:
- `filename`: string (e.g., `001-build-fix.patch`)
- `order`: integer (sequence number for application)
- `target_files`: array<string> (files modified by patch)
- `description`: string (human-readable purpose)
- `created_for_tag`: string (which upstream version this patch targets)
- `content_hash`: string (SHA256 of patch content)
- `status`: enum (pending, applied, failed, skipped)

**Validation Rules**:
- `filename` must match pattern `\d{3}-.*\.patch`
- `order` must be unique within patch set
- `content` must be valid unified diff format
- Patch must apply cleanly with `patch -p1 --dry-run`

**State Transitions**:
```
PENDING → VALIDATED (dry-run succeeds)
VALIDATED → APPLIED (patch applied successfully)
VALIDATED → FAILED (patch application error)
APPLIED → VERIFIED (build artifact contains changes)
```

**Relationships**:
- Applied to Upstream Source Reference
- Referenced in Build Execution logs
- Impacts Build Artifact content

### 3. Build Artifact

**Description**: Output from successful build execution

**Attributes**:
- `artifact_type`: enum (flatpak, binary, sbom, provenance)
- `oci_ref`: string (OCI registry reference with digest)
- `digest`: string (SHA256 immutable identifier)
- `size_bytes`: integer
- `created_at`: timestamp
- `source_tag`: string (upstream release tag)
- `patches_applied`: array<string> (list of patch filenames)
- `build_id`: string (Tekton PipelineRun ID)
- `retention_policy`: enum (permanent, two_week)
- `expiration_date`: timestamp (null if permanent, calculated date if two_week)

**Validation Rules**:
- `oci_ref` must include digest (e.g., `@sha256:...`)
- `digest` must match actual artifact content hash
- `retention_policy=permanent` only for builds from tagged releases
- `retention_policy=two_week` for builds from non-tagged commits
- `expiration_date` must be exactly 14 days after `created_at` when `retention_policy=two_week`
- SBOM must be present for all flatpak artifacts

**State Transitions**:
```
BUILDING → COMPLETED (build succeeds)
COMPLETED → PUBLISHED (pushed to OCI registry)
PUBLISHED → VERIFIED (installation test passes)
VERIFIED → RETAINED (retention policy applied)
RETAINED → EXPIRED (if two_week policy and 14 days passed)
EXPIRED → DELETED (artifact removed from registry)
```

**Relationships**:
- Generated by Build Execution
- Stored in OCI Registry
- Has attached Provenance Attestation
- Has attached SBOM

### 4. Build Pipeline Configuration

**Description**: Tekton pipeline definition orchestrating build process

**Attributes**:
- `pipeline_name`: string (e.g., `podman-desktop-build`)
- `tasks`: array<TaskReference> (ordered list of pipeline tasks)
- `parameters`: map<string, any> (configurable values)
- `workspaces`: array<WorkspaceBinding> (shared storage)
- `triggers`: array<TriggerRef> (webhook configurations)
- `version`: string (pipeline definition version)

**Validation Rules**:
- At least one task must be defined
- Task dependencies must form DAG (no cycles)
- Required parameters must have defaults or be marked as required
- Workspace names must be unique

**Task References** (embedded):
- `git-submodule-clone`: Clone upstream with submodules
- `validate-toolchain`: Check build environment
- `apply-patches`: Apply patch files sequentially
- `prefetch-dependencies`: Cache npm/pnpm packages
- `build-application`: Compile podman-desktop
- `build-flatpak`: Generate flatpak package
- `sign-artifact`: Sign flatpak (if certificates available)
- `push-artifact`: Push to OCI registry
- `generate-sbom`: Create software bill of materials

**Relationships**:
- References Upstream Source Reference for clone
- Uses Patch Files for modification
- Produces Build Artifacts
- Triggered by Tag Release Events

### 5. Flatpak Manifest

**Description**: Configuration for flatpak package generation (container.yaml)

**Attributes**:
- `app_id`: string (e.g., `io.podman_desktop.PodmanDesktop`)
- `runtime`: string (flatpak runtime name)
- `runtime_version`: string (e.g., `45`)
- `sdk`: string (SDK for build)
- `packages`: array<string> (RPM/system packages)
- `environment_vars`: map<string, string>
- `permissions`: array<string> (flatpak permissions)
- `cleanup_commands`: array<string>

**Validation Rules**:
- `app_id` must follow reverse-DNS format
- `runtime` and `sdk` must be available in configured repos
- `packages` must be resolvable from configured package sources
- `permissions` must be valid flatpak permission strings

**Relationships**:
- Used by `build-flatpak` task
- Embedded in Build Container Definition
- Influences Build Artifact structure

### 6. Build Container Definition

**Description**: Multi-stage Containerfile for flatpak build

**Attributes**:
- `base_image`: string (builder base image reference)
- `stages`: array<BuildStage>
- `build_args`: map<string, string>
- `labels`: map<string, string> (OCI metadata)

**Build Stages** (embedded):
1. **Install Stage**:
   - Copy container.yaml
   - Run `flatpak-container container-install`
   - Output: installed flatpak tree

2. **Export Stage**:
   - Mount install stage output
   - Run `flatpak-container container-export`
   - Output: OCI archive

3. **Final Stage**:
   - Use exported OCI archive
   - Remove temporary files
   - Label with provenance metadata

**Relationships**:
- Uses Flatpak Manifest (container.yaml)
- Referenced by Build Pipeline Configuration
- Produces Build Artifact (flatpak package)

### 7. Tag Release Event

**Description**: Webhook trigger from upstream repository tag creation

**Attributes**:
- `event_type`: string (e.g., `push`)
- `ref`: string (e.g., `refs/tags/v1.10.0`)
- `repository`: string (full repository URL)
- `tag_name`: string (extracted tag, e.g., `v1.10.0`)
- `commit_sha`: string (commit the tag points to)
- `timestamp`: timestamp

**Validation Rules**:
- `ref` must match pattern `refs/tags/v*`
- `tag_name` must be semantic version format
- `repository` must match configured upstream
- Event must be authentic (webhook signature verification)

**State Transitions**:
```
RECEIVED → VALIDATED (signature and format checked)
VALIDATED → QUEUED (build scheduled)
QUEUED → BUILDING (pipeline started)
```

**Relationships**:
- Triggers Build Pipeline Configuration
- Updates Upstream Source Reference to new tag
- Results in Build Artifact with `source_tag` set

## Entity Relationships Diagram

```text
Tag Release Event
    |
    | triggers
    v
Build Pipeline Configuration
    |
    | uses
    +---> Upstream Source Reference (clones at specific tag)
    |
    | applies
    +---> Patch Files (sequential application)
    |
    | builds via
    +---> Build Container Definition
    |         |
    |         | uses
    |         +---> Flatpak Manifest
    |
    | produces
    v
Build Artifact (flatpak package in OCI registry)
    |
    | has
    +---> Provenance Attestation
    +---> SBOM
```

## Lifecycle Flow

1. **Tag Release Event** received from upstream repository
2. **Build Pipeline Configuration** triggered via webhook
3. **git-submodule-clone** task clones **Upstream Source Reference** at tag
4. **validate-toolchain** task checks environment (fail-fast)
5. **apply-patches** task applies **Patch Files** sequentially
6. **prefetch-dependencies** task caches npm/pnpm packages
7. **build-flatpak** task uses **Build Container Definition** and **Flatpak Manifest**
8. **Build Artifact** created and pushed to OCI registry
9. Provenance and SBOM attached to artifact
10. Retention policy applied (permanent for tagged releases)

## Validation Matrix

| Entity | Required Fields | Optional Fields | Validation Method |
|--------|----------------|-----------------|-------------------|
| Upstream Source Reference | repository_url, reference_value | submodule_path | git ls-remote check |
| Patch File | filename, order, content | description, created_for_tag | patch --dry-run |
| Build Artifact | oci_ref, digest, artifact_type | sbom, provenance | OCI manifest verification |
| Build Pipeline | pipeline_name, tasks | parameters, triggers | Tekton validation |
| Flatpak Manifest | app_id, runtime, sdk | packages, permissions | flatpak-builder --show-manifest |
| Build Container | base_image, stages | build_args, labels | buildah/podman build --dry-run |
| Tag Release Event | ref, repository, tag_name | commit_sha | Webhook signature verification |
